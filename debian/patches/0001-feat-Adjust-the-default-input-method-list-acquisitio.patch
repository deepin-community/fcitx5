From 03f5fb7d3d5ec3b0e2ce92c67cfa2509af0ffe02 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E6=9D=8E=E6=88=90=E5=88=9A?= <lichenggang@uniontech.com>
Date: Mon, 22 Jul 2024 08:20:12 +0800
Subject: [PATCH] feat: Adjust the default input method list acquisition logic

---
 data/default/zh_CN         |  2 +-
 data/default/zh_HK         |  1 +
 data/default/zh_TW         |  1 +
 src/lib/fcitx/instance.cpp | 13 +++++++++++--
 4 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/data/default/zh_CN b/data/default/zh_CN
index b58579e..8845edd 100644
--- a/data/default/zh_CN
+++ b/data/default/zh_CN
@@ -1,3 +1,3 @@
 [DefaultInputMethod]
-0=pinyin
+0=fcitx5-com.sogou.ime.ng.fcitx5.deepin
 1=rime
diff --git a/data/default/zh_HK b/data/default/zh_HK
index bc9b8fb..a27e8cc 100644
--- a/data/default/zh_HK
+++ b/data/default/zh_HK
@@ -1,3 +1,4 @@
 [DefaultInputMethod]
 0=cangjie
 1=rime
+2=fcitx5-com.sogou.ime.ng.fcitx5.deepin
diff --git a/data/default/zh_TW b/data/default/zh_TW
index 28ce08f..52031df 100644
--- a/data/default/zh_TW
+++ b/data/default/zh_TW
@@ -1,2 +1,3 @@
 [DefaultInputMethod]
 0=chewing
+1=fcitx5-com.sogou.ime.ng.fcitx5.deepin
diff --git a/src/lib/fcitx/instance.cpp b/src/lib/fcitx/instance.cpp
index 4aaae06..234480f 100644
--- a/src/lib/fcitx/instance.cpp
+++ b/src/lib/fcitx/instance.cpp
@@ -340,9 +340,12 @@ void InstancePrivate::buildDefaultGroup() {
     // Figure out the first available default input method.
     std::string defaultIM;
+    std::vector<std::string> imList;
+    bool isFirstInputMethod = true;
     for (const auto &im : defaultIMConfig.defaultInputMethods.value()) {
-        if (imManager_.entry(im)) {
+        if (isFirstInputMethod && imManager_.entry(im)) {
             defaultIM = im;
-            break;
+ 	        isFirstInputMethod = !isFirstInputMethod;
+            continue;
         }
     }
 
@@ -364,6 +365,14 @@ void InstancePrivate::buildDefaultGroup() {
             group.inputMethodList().emplace_back(
                 InputMethodGroupItem(defaultIM));
         }
+
+	//Import the input method list of the configuration file into the group in sequence
+	for(const auto &im : imList)
+        {
+            group.inputMethodList().emplace_back(
+                InputMethodGroupItem(im));
+        }
+        
         FCITX_INFO() << "Items in " << groupName << ": "
                      << group.inputMethodList();
         group.setDefaultLayout(imLayout);
-- 
2.20.1

